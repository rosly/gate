#include <assert.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include "sodium.h"
#include "uart_log.h"

static const uint8_t pk[crypto_sign_ed25519_PUBLICKEYBYTES] =
   { 0x56, 0x53, 0x21, 0xd2, 0x6f, 0xa3, 0x11, 0x78, 0x13, 0x11, 0xfa, 0xae,
     0x1f, 0xaa, 0xdb, 0x14, 0x58, 0x78, 0x63, 0xa4, 0xa7, 0xe2, 0xf4, 0xb8,
     0x64, 0x5f, 0x7f, 0x52, 0x54, 0xbd, 0x33, 0x9f };
static const uint8_t sk[crypto_sign_ed25519_SECRETKEYBYTES] = 
   { 0x3d, 0xde, 0xd9, 0x53, 0x1c, 0x73, 0xf0, 0x66, 0xc6, 0x03, 0x73, 0x04,
     0x7f, 0xad, 0x33, 0x33, 0x65, 0x25, 0xa5, 0x1d, 0x95, 0x1f, 0x02, 0x49,
     0x46, 0x6d, 0x5d, 0x38, 0xe9, 0x22, 0xed, 0x9c, 0x56, 0x53, 0x21, 0xd2,
     0x6f, 0xa3, 0x11, 0x78, 0x13, 0x11, 0xfa, 0xae, 0x1f, 0xaa, 0xdb, 0x14,
     0x58, 0x78, 0x63, 0xa4, 0xa7, 0xe2, 0xf4, 0xb8, 0x64, 0x5f, 0x7f, 0x52,
     0x54, 0xbd, 0x33, 0x9f };
static uint8_t sig[crypto_sign_ed25519_BYTES];
static const uint8_t msg[] = { 0x00, 0x01, 0x02, 0x03 };
static const size_t msg_len = 4;

int test_sign(void)
{
	if (crypto_sign_ed25519_verify_detached(sig, msg, msg_len, pk)) {
		log_printf("Sig verify error\n");
		return -1;
	}

	log_printf("Sig OK!\n");
	return 0;
}

int test_full_sign(void)
{
	unsigned long long sig_len;

	if (crypto_sign_ed25519_detached(sig, &sig_len, msg, msg_len, sk)) {
		log_printf("Sign error\n");
		return -1;
	}

	if (crypto_sign_ed25519_verify_detached(sig, msg, msg_len, pk)) {
		log_printf("Verify error\n");
		return -1;
	}

	char pk_hex[crypto_sign_PUBLICKEYBYTES * 2 + 1];
	char sk_hex[crypto_sign_SECRETKEYBYTES * 2 + 1];
	char sig_hex[crypto_sign_ed25519_BYTES * 2 + 1];
	sodium_bin2hex(pk_hex, sizeof pk_hex, pk, sizeof pk);
	sodium_bin2hex(sk_hex, sizeof sk_hex, sk, sizeof sk);
	sodium_bin2hex(sig_hex, sizeof sig_hex, sig, sizeof sig);
	log_printf("pk: [%s]\n", pk_hex);
	log_printf("sk: [%s]\n", sk_hex);
	log_printf("sig: [%s]\n", sig_hex);

	log_printf("OK!\n");
	return 0;
}
